# 2장 테스트 환경 구성하기

## 2. 베이그런트로 테스트 환경 구축하기

```
Vagrantfile을 수정해 원하는 구성이 자동으로 CentOS에 입력되도록 해 보자.
```

---

### 1) 가상 머신에 필요한 설정 자동으로 구성하기

![4](https://user-images.githubusercontent.com/87686562/152557442-2663e84d-a571-4848-8804-f9c640a3cbd8.jpg)

```
2-1에서는 Vagrantfile에 기존에 있던 이미지 파일을 추가해 가상 머신을 생성했다.
이번에는 원하는 구성을 자동으로 생성할 수 있도록 새롭게 작성해 보자.
베이그런트 코드는 루비 언어로 작성한다.
```

- 코드 입력

  ```
  $ code . Vagrantfile
  ```

  ```ruby
  # -*- mode: ruby -*-
  # vi: set ft=ruby :
  Vagrant.configure("2") do |config|
      config.vm.define "m-k8s" do |cfg|
          cfg.vm.box = "sysnet4admin/CentOS-k8s"
          cfg.vm.provider "virtualbox" do |vb|
              vb.name = "m-k8s(github_SysNet4Admin)"
              vb.cpus = 6
              vb.memory = 4032
              vb.customize ["modifyvm", :id, "--groups", "/k8s-SM(github_SysNet4Admin)"]
          end
          cfg.vm.host_name = "m-k8s"
          cfg.vm.network "private_network", ip: "192.168.1.10"
          cfg.vm.network "forwarded_port", guest: 22, host: 60010, auto_correct: true, id: "ssh"
          cfg.vm.synced_folder "../data", "/vagrant", disabled: true
      end
  end
  ```

  ```
  1~2행 : 에디터에 현재 파일이 ruby 언어임을 인식하게 하는 호환 코드.
  		여기서 ft는 파일 종류의 약자이며, 해당 내용은 실행에 아무런 영향을 미치지 않음.
  
  3행 : "2"는 vagrant에서 ruby로 코드를 읽어 들여 실행할 때 작동하는 API 버전이고,
  	  뒤의 do |config|는 vagrant 설정의 시작을 알림.
  
  4행 : virtual box에서 보이는 가상 머신을 "m-k8s"로 정의하고, do |cfg|를 추가해 원하는 설정으로 변경.
  	  이렇게 do |이름|으로 시작한 작업은 end로 종료함.
  
  5행 : 기본값 config.vm.box를 do |cfg|에 적용한 내용을 받아 cfg.vm.box로 변경한다.
  
  6행 : vagrant의 provider가 virtual box라는 것을 정의한다.
  	  provider는 vagrant를 통해 제공되는 코드가 실제로 가상 머신으로 배포되게 하는 소프트웨어이다.
  	  virtual box가 여기에 해당한다.
  	  다음으로 virtual box에서 필요한 설정을 정의하는데, 그 시작을 do |vb|로 선언한다.
  	  
  7~11행 : virtual box에 생성한 가상 머신의 이름, CPU 수, Memory size, 소속된 그룹을 명시.
  		 그리고 마지막으로 end를 적어 virtual box 설정이 끝났음을 알림.
  
  12행 : 여기부터는 가상 머신 자체에 대한 설정으로, do |cfg|에 속한 작업이다.
  	   12행은 호스트의 이름(m-k8s)을 설정함.
  
  13행 : 호스트 전용 네트워크를 private_network로 설정해
  	   eth1 인터페이스를 호스트 전용으로 구성하고 IP는 192.168.1.10으로 지정한다.
  
  14행 : ssh 통신은 호스트 60010번을 게스트 22번으로 전달되도록 구성한다.
  	   이때 혹시 모를 포트 중복을 대비해 auto_correct: true로 설정해서
  	   포트가 중복되면 포트가 자동으로 변경되도록 한다.
  
  15행 : 호스트(PC 또는 노트북)와 게스트(가상 머신) 사이에 디렉터리 동기화가 이뤄지지 않게 설정함.
  
  16~17행 : 설정 작업(do |config|, do |cfg|)이 종료됐음을 end 구문으로 명시.
  		  이때 do와 end의 들여쓰기 위치가 정확하게 일치해야 함
  ```

- 코드 실행

  ```
  $ vagrant up
  Bringing machine 'm-k8s' up with 'virtualbox' provider...
  ...
  ==> m-k8s: Machine booted and ready!
  ==> m-k8s: Checking for guest additions in VM...
      m-k8s: The guest additions on this VM do not match the installed version of
      m-k8s: VirtualBox! In most cases this is fine, but in rare cases it can
      m-k8s: prevent things such as shared folders from working properly. If you see
      m-k8s: shared folder errors, please make sure the guest additions within the
      m-k8s: virtual machine match the version of VirtualBox you have installed on
      m-k8s: your host and reload your VM.
      m-k8s: 
      m-k8s: Guest Additions Version: 5.2.12
      m-k8s: VirtualBox Version: 6.1
  ==> m-k8s: Setting hostname...
  ==> m-k8s: Configuring and enabling network interfaces...
  ```

- 가상 머신 접속

  ```
  $ vagrant ssh
  [vagrant@m-k8s ~]$ 
  ```

- IP가 제대로 설정됐는지 확인

  ```
  [vagrant@m-k8s ~]$ ip addr show eth1
  3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
      link/ether 08:00:27:1d:9b:06 brd ff:ff:ff:ff:ff:ff
      inet 192.168.1.10/24 brd 192.168.1.255 scope global noprefixroute eth1
         valid_lft forever preferred_lft forever
      inet6 fe80::a00:27ff:fe1d:9b06/64 scope link 
         valid_lft forever preferred_lft forever
  ```

- 접속 종료

  ```
  [vagrant@m-k8s ~]$ exit
  logout
  Connection to 127.0.0.1 closed.
  ```

---

### 2) 가상 머신에 추가 패키지 설치하기

- 코드 입력

  ```
  $ code . Vagrantfile
  ```

  ```ruby
  # -*- mode: ruby -*-
  # vi: set ft=ruby :
  Vagrant.configure("2") do |config|
      config.vm.define "m-k8s" do |cfg|
          cfg.vm.box = "sysnet4admin/CentOS-k8s"
          cfg.vm.provider "virtualbox" do |vb|
              vb.name = "m-k8s(github_SysNet4Admin)"
              vb.cpus = 6
              vb.memory = 4032
              vb.customize ["modifyvm", :id, "--groups", "/k8s-SM(github_SysNet4Admin)"]
          end
          cfg.vm.host_name = "m-k8s"
          cfg.vm.network "private_network", ip: "192.168.1.10"
          cfg.vm.network "forwarded_port", guest: 22, host: 60010, auto_correct: true, id: "ssh"
          cfg.vm.synced_folder "../data", "/vagrant", disabled: true
          cfg.vm.provision "shell", path: "install_pkg.sh"        # 추가된 부분
      end
  end
  ```

  ```
  16행 : vm.provision "shell" 구문으로 경로에 있는 install_pkg.sh를
  	   게스트(CentOS) 내부에서 호출해 실행되도록 함.
  ```

- 패키지 설치를 위한 스크립트 작성

  ```
  Vagrantfile이 위치한 디렉터리에서 추가 패키지를 설치하기 위한 스크립트를 작성하고 install_pkg.sh로 저장.
  
  $ code . install_pkg.sh
  ```

  ```sh
  #!/usr/bin/env bash
  # install packages
  yum install epel-release -y
  yum install vim-enhanced -y
  ```

  ```
  Vagrantfile에서 호출한 install_pkg.sh로 입력해 둔 배시 셸 파일을 실행해
  EPEL(Extra Packages for Enterprise Linux) 저장소와 코드 하이라이트를 위한 Vim의 추가 기능을 설치.
  ```

- 코드 실행

  ```
  $ vagrant provision
  ==> m-k8s: Running provisioner: shell...
      m-k8s: Running: /tmp/vagrant-shell20220205-30615-8qa1b0.sh
  ...
      m-k8s: Complete!
  ```

- 가상 머신 접속

  ```
  $ vagrant ssh
  [vagrant@m-k8s ~]$ 
  ```

- EPEL 저장소가 구성됐는지 확인

  ```
  [vagrant@m-k8s ~]$ yum repolist
  Loaded plugins: fastestmirror
  Determining fastest mirrors
   * base: mirror.kakao.com
   * epel: ftp.iij.ad.jp
   * extras: mirror.kakao.com
   * updates: mirror.kakao.com
  repo id                               repo name                                                            status
  base/7/x86_64                         CentOS-7 - Base                                                      10,072
  epel/x86_64                           Extra Packages for Enterprise Linux 7 - x86_64                       13,719
  extras/7/x86_64                       CentOS-7 - Extras                                                       500
  updates/7/x86_64                      CentOS-7 - Updates                                                    3,407
  repolist: 27,698
  ```

- 문법 하이라이트가 적용됐는지 확인

  ```
  [vagrant@m-k8s ~]$ vim .bashrc
  ```

- 가상 머신 종료 & 삭제

  ```
  [vagrant@m-k8s ~]$ exit
  logout
  Connection to 127.0.0.1 closed.
  
  $ vagrant destroy -f
  ==> m-k8s: Forcing shutdown of VM...
  ==> m-k8s: Destroying VM and associated drives...
  ```

  