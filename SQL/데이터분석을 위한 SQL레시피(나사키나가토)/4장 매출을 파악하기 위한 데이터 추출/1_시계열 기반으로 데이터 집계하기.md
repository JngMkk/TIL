# 시계열 기반으로 데이터 집계하기

```
분석 현장에서는 시계열로 매출 금액, 사용자 수, 페이지 뷰 등의 다양한 데이터를 집계하는 경우가 많다.
이는 웹사이트 또는 서비스의 상태를 파악할 때 굉장히 중요한 작업이다.

예를 들어 매일 매출을 단순하게 수치로만 확인하면 장기적인 관점에서 어떤 경향이 있는지 알 수 없다.
하지만 시계열로 매출 금액을 집계하면 어떤 규칙성을 찾을 수도 있으며, 어떤 기간과 비교했을 때 변화폭을 확인할 수도 있다.

데이터의 집약뿐만 아니라, 변화를 이해하기 쉽게 표현할 수 있는 리포팅 방법을 사용하면,
매출을 단순한 꺾은선 그래프로 나타냈을 때는 찾아내기 힘든 변화를 명확하게 시각적으로 확인할 수 있다.
```

- purchase_log 테이블

  ```
       dt     | order_id |  user_id   | purchase_amount 
  ------------+----------+------------+-----------------
   2014-01-01 |        1 | rhwpvvitou |           13900
   2014-01-01 |        2 | hqnwoamzic |           10616
   2014-01-02 |        3 | tzlmqryunr |           21156
   2014-01-02 |        4 | wkmqqwbyai |           14893
   2014-01-03 |        5 | ciecbedwbq |           13054
   2014-01-03 |        6 | svgnbqsagx |           24384
   2014-01-03 |        7 | dfgqftdocu |           15591
   2014-01-04 |        8 | sbgqlzkvyn |            3025
   2014-01-04 |        9 | lbedmngbol |           24215
   2014-01-04 |       10 | itlvssbsgx |            2059
   2014-01-05 |       11 | jqcmmguhik |            4235
   2014-01-05 |       12 | jgotcrfeyn |           28013
   2014-01-05 |       13 | pgeojzoshx |           16008
   2014-01-06 |       14 | msjberhxnx |            1980
   2014-01-06 |       15 | tlhbolohte |           23494
   2014-01-06 |       16 | gbchhkcotf |            3966
   2014-01-07 |       17 | zfmbpvpzvu |           28159
   2014-01-07 |       18 | yauwzpaxtx |            8715
   2014-01-07 |       19 | uyqboqfgex |           10805
   2014-01-08 |       20 | hiqdkrzcpq |            3462
   2014-01-08 |       21 | zosbvlylpv |           13999
   2014-01-08 |       22 | bwfbchzgnl |            2299
   2014-01-09 |       23 | zzgauelgrt |           16475
   2014-01-09 |       24 | qrzfcwecge |            6469
   2014-01-10 |       25 | njbpsrvvcq |           16584
   2014-01-10 |       26 | cyxfgumkst |           11339
  (26 rows)
  ```

  

## 1. 날짜별 매출 집계하기

> GROUP BY 구문, SUM 함수, AVG 함수

```
매출을 집계하는 업무에서는 가로 축에 날짜, 세로 축에 금액을 표현하는 그래프를 사용한다.
날짜별로 매출을 집계하고, 동시에 평균 구매액을 집계한다.
```

- 날짜별 매출과 평균 구매액을 집계하는 쿼리

  ```sql
  SELECT
  	dt
  	, COUNT(*) AS purchase_count
  	, SUM(purchase_amount) AS total_amount
  	, AVG(purchase_amount) AS avg_amount
  FROM purchase_log
  GROUP BY dt
  ORDER BY dt
  ;
  ```

  ```
       dt     | pusrchase_count | total_amount |       avg_amount       
  ------------+-----------------+--------------+------------------------
   2014-01-01 |               2 |        24516 | 12258.0000000000000000
   2014-01-02 |               2 |        36049 |     18024.500000000000
   2014-01-03 |               3 |        53029 |     17676.333333333333
   2014-01-04 |               3 |        29299 |  9766.3333333333333333
   2014-01-05 |               3 |        48256 |     16085.333333333333
   2014-01-06 |               3 |        29440 |  9813.3333333333333333
   2014-01-07 |               3 |        47679 |     15893.000000000000
   2014-01-08 |               3 |        19760 |  6586.6666666666666667
   2014-01-09 |               2 |        22944 | 11472.0000000000000000
   2014-01-10 |               2 |        27923 | 13961.5000000000000000
  (10 rows)
  ```

---

## 2. 이동평균을 사용한 날짜별 추이 보기

> OVER(ORDER BY ~)

```
```



