# 사용자 전체의 특징과 경향 찾기

```sql
DROP TABLE IF EXISTS mst_users;
CREATE TABLE mst_users(
    user_id         varchar(255)
  , sex             varchar(255)
  , birth_date      varchar(255)
  , register_date   varchar(255)
  , register_device varchar(255)
  , withdraw_date   varchar(255)
);

INSERT INTO mst_users
VALUES
    ('U001', 'M', '1977-06-17', '2016-10-01', 'pc' , NULL        )
  , ('U002', 'F', '1953-06-12', '2016-10-01', 'sp' , '2016-10-10')
  , ('U003', 'M', '1965-01-06', '2016-10-01', 'pc' , NULL        )
  , ('U004', 'F', '1954-05-21', '2016-10-05', 'pc' , NULL        )
  , ('U005', 'M', '1987-11-23', '2016-10-05', 'sp' , NULL        )
  , ('U006', 'F', '1950-01-21', '2016-10-10', 'pc' , '2016-10-10')
  , ('U007', 'F', '1950-07-18', '2016-10-10', 'app', NULL        )
  , ('U008', 'F', '2006-12-09', '2016-10-10', 'sp' , NULL        )
  , ('U009', 'M', '2004-10-23', '2016-10-15', 'pc' , NULL        )
  , ('U010', 'F', '1987-03-18', '2016-10-16', 'pc' , NULL        )
;

DROP TABLE IF EXISTS action_log;
CREATE TABLE action_log(
    session  varchar(255)
  , user_id  varchar(255)
  , action   varchar(255)
  , category varchar(255)
  , products varchar(255)
  , amount   integer
  , stamp    varchar(255)
);

INSERT INTO action_log
VALUES
    ('989004ea', 'U001', 'purchase', 'drama' , 'D001,D002', 2000, '2016-11-03 18:10:00')
  , ('989004ea', 'U001', 'view'    , NULL    , NULL       , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'favorite', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'review'  , 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', NULL, 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 18:00:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D002'     , NULL, '2016-11-03 18:01:00')
  , ('989004ea', 'U001', 'add_cart', 'drama' , 'D001,D002', NULL, '2016-11-03 18:02:00')
  , ('989004ea', 'U001', 'purchase', 'drama' , 'D001,D002', 2000, '2016-11-03 18:10:00')
  , ('47db0370', 'U002', 'add_cart', 'drama' , 'D001'     , NULL, '2016-11-03 19:00:00')
  , ('47db0370', 'U002', 'purchase', 'drama' , 'D001'     , 1000, '2016-11-03 20:00:00')
  , ('47db0370', 'U002', 'add_cart', 'drama' , 'D002'     , NULL, '2016-11-03 20:30:00')
  , ('87b5725f', 'U001', 'add_cart', 'action', 'A004'     , NULL, '2016-11-04 12:00:00')
  , ('87b5725f', 'U001', 'add_cart', 'action', 'A005'     , NULL, '2016-11-04 12:00:00')
  , ('87b5725f', 'U001', 'add_cart', 'action', 'A006'     , NULL, '2016-11-04 12:00:00')
  , ('9afaf87c', 'U002', 'purchase', 'drama' , 'D002'     , 1000, '2016-11-04 13:00:00')
  , ('9afaf87c', NULL, 'purchase', 'action', 'A005,A006', 1000, '2016-11-04 15:00:00')
;
```

- 사용자 마스터 테이블

  ```
   user_id | sex | birth_date | register_date | register_device | withdraw_date 
  ---------+-----+------------+---------------+-----------------+---------------
   U001    | M   | 1977-06-17 | 2016-10-01    | pc              | 
   U002    | F   | 1953-06-12 | 2016-10-01    | sp              | 2016-10-10
   U003    | M   | 1965-01-06 | 2016-10-01    | pc              | 
   U004    | F   | 1954-05-21 | 2016-10-05    | pc              | 
   U005    | M   | 1987-11-23 | 2016-10-05    | sp              | 
   U006    | F   | 1950-01-21 | 2016-10-10    | pc              | 2016-10-10
   U007    | F   | 1950-07-18 | 2016-10-10    | app             | 
   U008    | F   | 2006-12-09 | 2016-10-10    | sp              | 
   U009    | M   | 2004-10-23 | 2016-10-15    | pc              | 
   U010    | F   | 1987-03-18 | 2016-10-16    | pc              | 
  ```

- 액션 로그 테이블

  ```
   session  | user_id |  action  | category | products  | amount |        stamp        
  ----------+---------+----------+----------+-----------+--------+---------------------
   989004ea | U001    | purchase | drama    | D001,D002 |   2000 | 2016-11-03 18:10:00
   989004ea | U001    | view     |          |           |        | 2016-11-03 18:00:00
   989004ea | U001    | favorite | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | review   | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D001      |        | 2016-11-03 18:00:00
   989004ea | U001    | add_cart | drama    | D002      |        | 2016-11-03 18:01:00
   989004ea | U001    | add_cart | drama    | D001,D002 |        | 2016-11-03 18:02:00
   989004ea | U001    | purchase | drama    | D001,D002 |   2000 | 2016-11-03 18:10:00
   47db0370 | U002    | add_cart | drama    | D001      |        | 2016-11-03 19:00:00
   47db0370 | U002    | purchase | drama    | D001      |   1000 | 2016-11-03 20:00:00
   47db0370 | U002    | add_cart | drama    | D002      |        | 2016-11-03 20:30:00
   87b5725f | U001    | add_cart | action   | A004      |        | 2016-11-04 12:00:00
   87b5725f | U001    | add_cart | action   | A005      |        | 2016-11-04 12:00:00
   87b5725f | U001    | add_cart | action   | A006      |        | 2016-11-04 12:00:00
   9afaf87c | U002    | purchase | drama    | D002      |   1000 | 2016-11-04 13:00:00
   9afaf87c | U001    | purchase | action   | A005,A006 |   1000 | 2016-11-04 15:00:00
  ```

## 1. 사용자의 액션 수 집계하기

> COUNT 함수, COUNT(DISTINCT ~), ROLLUP 구문
>
> UU(Unique Users), 사용률, 개인별 통계

- 액션과 관련된 지표 집계하기

  ```
  특정 액션 UU를 전체 액션 UU로 나눈 것을 사용률이라 부름.
  이를 사용하면 특정 액션을 얼마나 자주 사용하는지 확인할 수 있음.
  추가로 사용자가 평균적으로 액션을 몇 번이나 사용했는지 확인할 수 있음.
  ```

  ```sql
  WITH
  stats AS (
  	-- 로그 전체의 유니크 사용자 수 구하기
      SELECT COUNT(DISTINCT session) AS total_uu
      FROM action_log
  )
  SELECT
  	l.action,
  	-- 액션 UU
  	COUNT(DISTINCT l.session) AS action_uu,
  	-- 액션의 수
  	COUNT(1) AS action_count,
  	-- 전체 UU
  	s.total_uu,
  	-- 사용률 : 액션 UU / 전체 UU
  	100.0 * COUNT(DISTINCT l.session) / s.total_uu AS usage_rate,
  	-- 1인당 액션 수 : 액션 수 / 액션 UU
  	1.0 * COUNT(1) / COUNT(DISTINCT l.session) AS count_per_user
  FROM action_log l
  -- 로그 전체의 유니크 사용자 수를 모든 레코드에 결합하기
  CROSS JOIN stats s
  GROUP BY l.action, s.total_uu
  ;
  ```

- 로그인 사용자와 비로그인 사용자를 구분해서 집계하기

  ```SQL
  SELECT
      session,
      user_id,
      action,
      -- user_id가 NULL 또는 빈 문자가 아닌 경우 login이라고 판정
      CASE WHEN COALESCE(user_id, '') <> '' THEN 'login' ELSE 'guest' END AS login_status
  FROM action_log
  ;
  ```

  ```
  user_id에 값이 들어 있다면 login_status를 login, 들어있지 않다면 guest가 되게 가공.
  login_status를 기반으로 액션 수와 UU를 집계함.
  
  login_status가 guest와 login인 경우 모두 로그인/비로그인을 따지지 않고 전체(all)에 함께 집계.
  이때 ROLLUP 구문을 사용
  ```

- 로그인 상태에 따라 액션 수 등을 따로 집계

  ```sql
  WITH
  action_log_with_status AS (
      SELECT
          session,
          user_id,
          action,
          -- user_id가 NULL 또는 빈 문자가 아닌 경우 login이라고 판정
          CASE WHEN COALESCE(user_id, '') <> '' THEN 'login' ELSE 'guest' END AS login_status
  	FROM action_log
  )
  SELECT
  	COALESCE(action, 'all') AS action,
  	COALESCE(login_status, 'all') AS login_status,
  	COUNT(DISTINCT session) AS action_uu,
  	COUNT(1) AS action_count
  FROM action_log_with_status
  GROUP BY ROLLUP(action, login_status)
  ;
  ```

## 회원과 비회원을 구분해서 집계하기

- 회원 상태를 판별하는 쿼리

  ```sql
  WITH
  action_log_with_status AS (
  	SELECT
      	session,
      	user_id,
      	action,
      	-- 로그를 타임스탬프 순으로 나열하고, 한 번이라도 로그인한 사용자일 경우
      	-- 이후의 모든 로그 상태를 member로 설정
      	CASE
      		WHEN COALESCE(MAX(user_id) OVER(PARTITION BY session ORDER BY stamp
                                             ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW), '') <> ''
      			THEN 'member'
      		ELSE 'none'
     		END AS member_status,
      	stamp
      FROM action_log
  )
  SELECT * FROM action_log_with_status
  ;
  ```

  

  